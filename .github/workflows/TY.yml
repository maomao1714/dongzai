name: é€šç”¨OpenWrtç¼–è¯‘å·¥ä½œæµï¼ˆå¼ºåŒ–ç‰ˆï¼‰

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®
      uses: actions/checkout@v4

    - name: ç£ç›˜ç©ºé—´ä¼˜åŒ–
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´ ==="
        df -h
        sudo swapoff -a
        sudo dd if=/dev/zero of=/swapfile bs=1G count=2
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "=== ç£ç›˜å’Œå†…å­˜çŠ¶æ€ ==="
        df -h
        free -h

    - name: æ¸…ç†ç³»ç»Ÿç¼“å­˜
      run: |
        echo "æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
        sudo apt-get clean
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc 2>/dev/null || true
        sudo rm -rf /usr/local/lib/node_modules 2>/dev/null || true
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /tmp/*

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½®æ–‡ä»¶ .config"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œå‰ä¸Šä¼  .config æ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"
        echo "=== é…ç½®æ–‡ä»¶é¢„è§ˆï¼ˆå‰30è¡Œï¼‰==="
        head -30 .config

    - name: æ£€æŸ¥é…ç½®æ–‡ä»¶å®Œæ•´æ€§
      run: |
        echo "ğŸ” æ·±åº¦æ£€æŸ¥é…ç½®æ–‡ä»¶..."
        
        # æ£€æŸ¥åŸºæœ¬æ¶æ„é…ç½®
        if ! grep -q "CONFIG_TARGET_[a-zA-Z]" .config; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ç›®æ ‡æ¶æ„é…ç½®"
          exit 1
        fi
        
        # æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬
        if ! grep -q "CONFIG_LINUX_[0-9]" .config; then
          echo "âš ï¸ è­¦å‘Šï¼šå¯èƒ½ç¼ºå°‘å†…æ ¸ç‰ˆæœ¬é…ç½®"
        fi
        
        # æ£€æŸ¥å…³é”®åŒ…
        CRITICAL_PACKAGES=("base-files" "busybox" "dnsmasq" "dropbear" "firewall" "kmod" "libc" "opkg" "procd" "uci" "ubus")
        for pkg in "${CRITICAL_PACKAGES[@]}"; do
          if ! grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "âš ï¸ è­¦å‘Šï¼šå»ºè®®åŒ…å«åŸºç¡€åŒ… $pkg"
          fi
        done
        
        echo "âœ… é…ç½®æ–‡ä»¶æ£€æŸ¥å®Œæˆ"

    - name: å®‰è£…å®Œæ•´ç¼–è¯‘ç¯å¢ƒ
      run: |
        echo "å®‰è£…å®Œæ•´ç¼–è¯‘ç¯å¢ƒ..."
        sudo apt-get update
        
        # æ·»åŠ Python 2.7æ”¯æŒ
        sudo apt-get install -y software-properties-common
        sudo add-apt-repository -y ppa:deadsnakes/ppa
        sudo apt-get update
        
        # å®‰è£…å®Œæ•´çš„ç¼–è¯‘å·¥å…·é“¾
        sudo apt-get install -y \
          build-essential \
          git \
          libncurses5-dev \
          libncursesw5-dev \
          libssl-dev \
          python2.7 \
          python3 \
          python3-pip \
          unzip \
          wget \
          curl \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          autoconf \
          automake \
          gettext \
          pkg-config \
          libtool \
          libc6-dev \
          m4 \
          gawk \
          sed \
          cmake \
          rsync \
          subversion \
          texinfo \
          zlib1g-dev \
          gperf \
          antlr3
        
        # åˆ›å»ºpython2ç¬¦å·é“¾æ¥
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        echo "âœ… å®Œæ•´ç¼–è¯‘ç¯å¢ƒå®‰è£…å®Œæˆ"

    - name: å…‹éš†æºç 
      run: |
        if [ -d "$BUILD_DIR" ]; then
          echo "åˆ é™¤å·²å­˜åœ¨çš„ $BUILD_DIR ç›®å½•"
          rm -rf "$BUILD_DIR"
        fi
        echo "å¼€å§‹å…‹éš†æºç ..."
        git clone --depth=1 --single-branch "$REPO_URL" "$BUILD_DIR"
        if [ $? -ne 0 ]; then
          echo "âŒ æºç å…‹éš†å¤±è´¥"
          exit 1
        fi
        echo "âœ… æºç å…‹éš†å®Œæˆ"

    - name: åº”ç”¨è‡ªå®šä¹‰feedsé…ç½®
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æ£€æŸ¥ä»“åº“æ ¹ç›®å½•æ˜¯å¦æœ‰feeds.conf.defaultæ–‡ä»¶
        if [ -f "feeds.conf.default" ]; then
          echo "ğŸ“‹ æ‰¾åˆ°è‡ªå®šä¹‰çš„feeds.conf.defaultï¼Œå°†å…¶å¤åˆ¶åˆ°ç¼–è¯‘ç›®å½•"
          cp "feeds.conf.default" "$BUILD_DIR/feeds.conf.default"
          echo "âœ… å·²åº”ç”¨è‡ªå®šä¹‰feedsé…ç½®"
          
          # æ˜¾ç¤ºfeedsé…ç½®é¢„è§ˆ
          echo "=== feedsé…ç½®é¢„è§ˆï¼ˆå‰20è¡Œï¼‰==="
          head -20 "$BUILD_DIR/feeds.conf.default"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°è‡ªå®šä¹‰feeds.conf.defaultï¼Œå°†ä½¿ç”¨æºç é»˜è®¤é…ç½®"
        fi

    - name: æ›´æ–°è½¯ä»¶æº
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        cd "$BUILD_DIR"
        echo "å¼€å§‹æ›´æ–°è½¯ä»¶æº..."
        
        # å¤šæ¬¡å°è¯•æ›´æ–°feeds
        for i in {1..3}; do
          echo "ç¬¬ $i æ¬¡å°è¯•æ›´æ–°feeds..."
          if ./scripts/feeds update -a; then
            echo "âœ… feedsæ›´æ–°æˆåŠŸ"
            break
          else
            echo "âš ï¸ ç¬¬ $i æ¬¡feedsæ›´æ–°å¤±è´¥"
            if [ $i -eq 3 ]; then
              echo "âŒ feedsæ›´æ–°å½»åº•å¤±è´¥"
              exit 1
            fi
            sleep 5
          fi
        done
        
        # å®‰è£…feeds
        echo "å®‰è£…feeds..."
        if ./scripts/feeds install -a; then
          echo "âœ… feedså®‰è£…æˆåŠŸ"
        else
          echo "âš ï¸ feedså®‰è£…æœ‰é”™è¯¯ï¼Œä½†ç»§ç»­æ‰§è¡Œ..."
        fi

    - name: åº”ç”¨é…ç½®
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd "$BUILD_DIR"
        
        echo "å¤åˆ¶é…ç½®æ–‡ä»¶..."
        if [ -f "../.config" ]; then
          cp "../.config" ".config"
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        else
          echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°.configæ–‡ä»¶"
          exit 1
        fi
        
        echo "åº”ç”¨é»˜è®¤é…ç½®..."
        if make defconfig; then
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
        else
          echo "âŒ é…ç½®åº”ç”¨å¤±è´¥ï¼Œå°è¯•æ¸…ç†åé‡è¯•..."
          make clean
          make defconfig
        fi

    - name: é¢„ç¼–è¯‘æ£€æŸ¥å’Œä¿®å¤
      run: |
        cd "$BUILD_DIR"
        echo "ğŸ”§ æ‰§è¡Œé¢„ç¼–è¯‘æ£€æŸ¥å’Œä¿®å¤..."
        
        # æ£€æŸ¥é…ç½®å®Œæ•´æ€§å¹¶ä¿®å¤
        echo "æ£€æŸ¥é…ç½®å®Œæ•´æ€§..."
        
        # ç¡®ä¿æœ‰æ–‡ä»¶ç³»ç»Ÿ
        if ! grep -q "CONFIG_TARGET_ROOTFS" .config; then
          echo "æ·»åŠ é»˜è®¤æ–‡ä»¶ç³»ç»Ÿé…ç½®..."
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
          echo "CONFIG_TARGET_ROOTFS_SQUASHFS=y" >> .config
        fi
        
        # ç¡®ä¿æœ‰åŸºç¡€åŒ…
        BASE_PACKAGES=("base-files" "busybox" "dropbear" "firewall" "kmod" "libc" "opkg" "procd" "uci")
        for pkg in "${BASE_PACKAGES[@]}"; do
          if ! grep -q "CONFIG_PACKAGE_${pkg}=y" .config; then
            echo "æ·»åŠ åŸºç¡€åŒ…: $pkg"
            echo "CONFIG_PACKAGE_${pkg}=y" >> .config
          fi
        done
        
        # é‡æ–°åº”ç”¨é…ç½®
        echo "é‡æ–°åº”ç”¨é…ç½®..."
        make defconfig
        
        echo "âœ… é¢„ç¼–è¯‘æ£€æŸ¥å®Œæˆ"

    - name: ç¼–è¯‘å‰æ¸…ç†
      run: |
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        echo "æ‰§è¡Œæœ€ç»ˆæ¸…ç†..."
        sudo apt-get clean
        sudo rm -rf /var/cache/apt/archives/*
        
        # ç§»é™¤.gitç›®å½•èŠ‚çœç©ºé—´
        if [ -d "$BUILD_DIR/.git" ]; then
          echo "ç§»é™¤.gitç›®å½•èŠ‚çœç©ºé—´..."
          rm -rf "$BUILD_DIR/.git"
        fi
        
        echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd "$BUILD_DIR"
        THREADS=${{ github.event.inputs.compile_threads }}
        
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆä½¿ç”¨ $THREADS çº¿ç¨‹ï¼‰..."
        for i in {1..5}; do
          echo "ç¬¬ $i æ¬¡å°è¯•ä¸‹è½½..."
          if make download -j$THREADS; then
            echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
            break
          else
            echo "âš ï¸ ç¬¬ $i æ¬¡ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•..."
            sleep 10
          fi
        done
        
        if [ $? -ne 0 ]; then
          echo "âŒ è½¯ä»¶åŒ…ä¸‹è½½å¤±è´¥ï¼Œä½†ç»§ç»­å°è¯•ç¼–è¯‘..."
        fi

    - name: åˆ†æ­¥ç¼–è¯‘ï¼ˆå®¹é”™æ¨¡å¼ï¼‰
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd "$BUILD_DIR"
        THREADS=${{ github.event.inputs.compile_threads }}
        
        echo "å¼€å§‹åˆ†æ­¥ç¼–è¯‘..."
        echo "=== å½“å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        echo "=== å†…å­˜ä½¿ç”¨æƒ…å†µ ==="
        free -h
        
        echo "ğŸ”§ ä½¿ç”¨å®¹é”™æ¨¡å¼ç¼–è¯‘..."
        
        # åˆ†æ­¥ç¼–è¯‘ï¼Œæ¯ä¸€æ­¥éƒ½æ£€æŸ¥ç»“æœ
        COMPILE_STEPS=(
          "tools/compile"
          "toolchain/compile" 
          "target/compile"
          "package/compile"
          "package/index"
        )
        
        for step in "${COMPILE_STEPS[@]}"; do
          echo "=========================================="
          echo "æ‰§è¡Œç¼–è¯‘æ­¥éª¤: $step"
          echo "=========================================="
          
          for attempt in {1..2}; do
            echo "ç¬¬ $attempt æ¬¡å°è¯•..."
            if make $step -j$THREADS; then
              echo "âœ… $step å®Œæˆ"
              break
            else
              echo "âš ï¸ $step ç¬¬ $attempt æ¬¡å°è¯•å¤±è´¥"
              if [ $attempt -eq 2 ]; then
                echo "âŒ $step å½»åº•å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è¯¦ç»†æ¨¡å¼..."
                make $step -j1 V=s
                if [ $? -ne 0 ]; then
                  echo "âŒ $step å•çº¿ç¨‹ä¹Ÿå¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€ä¸ªæ­¥éª¤..."
                fi
              fi
              sleep 5
            fi
          done
        done
        
        echo "ğŸ‰ åˆ†æ­¥ç¼–è¯‘å®Œæˆ"

    - name: æœ€ç»ˆç¼–è¯‘
      run: |
        cd "$BUILD_DIR"
        THREADS=${{ github.event.inputs.compile_threads }}
        
        echo "æ‰§è¡Œæœ€ç»ˆå®Œæ•´ç¼–è¯‘..."
        if make -j$THREADS; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹è¯¦ç»†ç¼–è¯‘..."
          make -j1 V=s
        fi

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "ğŸ” æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶..."
        
        # å¤šç§æ–¹å¼æŸ¥æ‰¾å›ºä»¶æ–‡ä»¶
        find_command="find \"$BUILD_DIR/bin\" -type f \( -name \"*.bin\" -o -name \"*.img\" -o -name \"*.gz\" -o -name \"*.trx\" -o -name \"*.elf\" \) 2>/dev/null"
        FIRMWARE_FILES=$(eval $find_command)
        
        if [ -n "$FIRMWARE_FILES" ]; then
          echo "âœ… æ‰¾åˆ°ä»¥ä¸‹å›ºä»¶æ–‡ä»¶:"
          echo "$FIRMWARE_FILES"
          echo "=== æ–‡ä»¶å¤§å°ç»Ÿè®¡ ==="
          du -sh "$BUILD_DIR/bin/" 2>/dev/null || true
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰æ•ˆï¼ˆå¤§äº1MBï¼‰
          VALID_FILES=0
          while IFS= read -r file; do
            if [ -f "$file" ] && [ $(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null) -gt 1048576 ]; then
              VALID_FILES=$((VALID_FILES + 1))
            fi
          done <<< "$FIRMWARE_FILES"
          
          echo "æœ‰æ•ˆå›ºä»¶æ–‡ä»¶æ•°: $VALID_FILES"
        else
          echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
          echo "=== ç›®å½•ç»“æ„ ==="
          find "$BUILD_DIR/bin" -type d 2>/dev/null | head -20
          exit 1
        fi
        
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: ${{ env.BUILD_DIR }}/bin/
        retention-days: 30

    - name: å¿«é€Ÿä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: quick-firmware
        path: |
          ${{ env.BUILD_DIR }}/bin/**/*.bin
          ${{ env.BUILD_DIR }}/bin/**/*.img
        retention-days: 7

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          ${{ env.BUILD_DIR }}/logs/
        retention-days: 7

    - name: å®Œæˆæç¤º
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸŠ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“¥ å›ºä»¶æ–‡ä»¶å¯åœ¨ArtifactsåŒºåŸŸä¸‹è½½ï¼š"
          echo "   - openwrt-firmware: å®Œæ•´ç¼–è¯‘è¾“å‡º"
          echo "   - quick-firmware: å¿«é€Ÿä¸‹è½½å›ºä»¶"
          echo "   - build-logs: ç¼–è¯‘æ—¥å¿—ï¼ˆç”¨äºè°ƒè¯•ï¼‰"
        else
          echo "âŒ ç¼–è¯‘è¿‡ç¨‹å‡ºç°é”™è¯¯"
          echo "ğŸ’¡ æ•…éšœæ’é™¤å»ºè®®:"
          echo "   1. æ£€æŸ¥ .config æ–‡ä»¶é…ç½®"
          echo "   2. æŸ¥çœ‹ build-logs ä¸­çš„è¯¦ç»†é”™è¯¯"
          echo "   3. ç¡®ä¿é€‰æ‹©äº†æ­£ç¡®çš„ç›®æ ‡æ¶æ„å’Œè®¾å¤‡"
          echo "   4. æ£€æŸ¥æ˜¯å¦åŒ…å«å¿…è¦çš„åŸºç¡€åŒ…"
          echo "   5. å°è¯•å‡å°‘ç¼–è¯‘çš„åŒ…æ•°é‡"
          echo "   6. æ£€æŸ¥ feeds.conf.default é…ç½®"
        fi
