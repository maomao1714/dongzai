name: é€šç”¨OpenWrtç¼–è¯‘å·¥ä½œæµ-ä¿®å¤ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®
      uses: actions/checkout@v4

    - name: æ‰©å±•ç£ç›˜ç©ºé—´
      run: |
        echo "=== æ‰©å±•ç£ç›˜ç©ºé—´ ==="
        sudo swapoff -a
        sudo dd if=/dev/zero of=/swapfile bs=1G count=4
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        echo "=== å½“å‰ç£ç›˜å’Œå†…å­˜çŠ¶æ€ ==="
        df -h
        free -h

    - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
      timeout-minutes: 15
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´çŠ¶æ€ ==="
        df -h
        echo "å¼€å§‹æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
        sudo apt-get clean
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc 2>/dev/null || true
        sudo rm -rf /usr/local/lib/node_modules 2>/dev/null || true
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /tmp/*
        echo "=== æ¸…ç†åç£ç›˜ç©ºé—´ ==="
        df -h

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½®æ–‡ä»¶ .config"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œå‰ä¸Šä¼  .config æ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•"
          exit 1
        fi
        echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"
        echo "=== é…ç½®æ–‡ä»¶å‰å‡ è¡Œé¢„è§ˆ ==="
        head -20 .config

    - name: å®‰è£…å®Œæ•´ç¼–è¯‘ç¯å¢ƒ
      timeout-minutes: 15
      run: |
        echo "å®‰è£…å®Œæ•´ç¼–è¯‘ç¯å¢ƒ..."
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          git \
          libncurses5-dev \
          libssl-dev \
          python3 \
          python2.7 \
          unzip \
          wget \
          curl \
          gcc \
          g++ \
          binutils \
          patch \
          bzip2 \
          flex \
          make \
          autoconf \
          gettext \
          pkg-config \
          libtool \
          libc6-dev \
          m4 \
          gawk \
          sed \
          cmake
        echo "âœ… ç¯å¢ƒå®‰è£…å®Œæˆ"
        sudo apt-get clean

    - name: å…‹éš†æºç 
      timeout-minutes: 10
      run: |
        if [ -d "$BUILD_DIR" ]; then
          echo "åˆ é™¤å·²å­˜åœ¨çš„ $BUILD_DIR ç›®å½•"
          rm -rf $BUILD_DIR
        fi
        echo "å¼€å§‹å…‹éš†æºç ..."
        git clone --depth=1 --single-branch $REPO_URL $BUILD_DIR
        if [ $? -ne 0 ]; then
          echo "âŒ æºç å…‹éš†å¤±è´¥"
          exit 1
        fi
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        df -h

    - name: æ›´æ–°è½¯ä»¶æº
      timeout-minutes: 10
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "å¼€å§‹æ›´æ–°è½¯ä»¶æº..."
        cd $BUILD_DIR
        ./scripts/feeds update -a
        if [ $? -ne 0 ]; then
          echo "âŒ è½¯ä»¶æºæ›´æ–°å¤±è´¥"
          exit 1
        fi
        ./scripts/feeds install -a
        if [ $? -ne 0 ]; then
          echo "âŒ è½¯ä»¶æºå®‰è£…å¤±è´¥"
          exit 1
        fi
        echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: åˆ›å»ºä¸»é¢˜ç›®å½•ç»“æ„
      run: |
        echo "åˆ›å»ºä¸»é¢˜ç›®å½•ç»“æ„..."
        mkdir -p "$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai/files/www/luci-static/dongzhai/css"
        mkdir -p "$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai/files/www/luci-static/dongzhai/js"
        echo "âœ… ä¸»é¢˜ç›®å½•åˆ›å»ºå®Œæˆ"

    - name: åˆ›å»ºä¸»é¢˜Makefile
      run: |
        THEME_DIR="$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai"
        if [ ! -d "$THEME_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼šä¸»é¢˜ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cat > "$THEME_DIR/Makefile" << 'EOF'
include $(TOPDIR)/rules.mk

LUCI_TITLE:=æ ‹ä»”ä¸»é¢˜
LUCI_DEPENDS:=
PKG_VERSION:=1.0
PKG_RELEASE:=1

include $(INCLUDE_DIR)/package.mk

define Package/luci-theme-dongzhai
  $(call Package/luci/webtemplate)
  TITLE:=æ ‹ä»”ä¸»é¢˜
  DEPENDS:=+luci-compat
endef

define Package/luci-theme-dongzhai/description
  æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜
endef

define Build/Configure
endef

define Build/Compile
endef

define Package/luci-theme-dongzhai/install
	$(INSTALL_DIR) $(1)/www/luci-static/dongzhai
	[ -d ./files ] && $(CP) ./files/* $(1)/www/luci-static/dongzhai/
endef

$(eval $(call BuildPackage,luci-theme-dongzhai))
EOF
        echo "âœ… ä¸»é¢˜Makefileåˆ›å»ºå®Œæˆ"

    - name: åˆ›å»ºä¸»é¢˜CSSæ–‡ä»¶
      run: |
        CSS_DIR="$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai/files/www/luci-static/dongzhai/css"
        if [ ! -d "$CSS_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼šCSSç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cat > "$CSS_DIR/style.css" << 'EOF'
/* æ ‹ä»”ä¸»é¢˜æ ·å¼ */
.header .fill .brand {
    color: #ff6600;
    font-weight: bold;
    font-size: 18px;
}
.sidebar {
    background: #2c3e50;
}
.sidebar .nav > li > a {
    color: #ecf0f1;
}
.btn-primary {
    background-color: #ff6600;
    border-color: #ff6600;
}
EOF
        echo "âœ… ä¸»é¢˜CSSåˆ›å»ºå®Œæˆ"

    - name: åº”ç”¨é…ç½®å’Œå‡†å¤‡ç¼–è¯‘
      timeout-minutes: 10
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd $BUILD_DIR
        
        echo "å¤åˆ¶é…ç½®æ–‡ä»¶..."
        if [ -f "../.config" ]; then
          cp ../.config .config
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å¤–éƒ¨é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
        fi
        
        echo "æ·»åŠ ä¸»é¢˜é…ç½®..."
        echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        echo "CONFIG_DEFAULT_luci-theme-dongzhai=y" >> .config
        
        echo "æ·»åŠ ç¼–è¯‘ä¼˜åŒ–é…ç½®..."
        cat >> .config << 'EOF'
# ç©ºé—´ä¼˜åŒ–
CONFIG_KERNEL_KALLSYMS=n
CONFIG_KERNEL_DEBUG_KERNEL=n
CONFIG_KERNEL_DEBUG_INFO=n
CONFIG_USE_STRIP=y
CONFIG_USE_SSTRIP=n
CONFIG_BUILD_NLS=n
CONFIG_CLEAN_IPKG=y
CONFIG_CCACHE=n
# CONFIG_SDK is not set
EOF
        
        echo "åº”ç”¨é»˜è®¤é…ç½®..."
        make defconfig
        if [ $? -ne 0 ]; then
          echo "âŒ é…ç½®åº”ç”¨å¤±è´¥"
          exit 1
        fi
        echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"

    - name: ç¼–è¯‘å‰æœ€ç»ˆæ¸…ç†
      timeout-minutes: 5
      run: |
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        echo "æ‰§è¡Œæœ€ç»ˆæ¸…ç†..."
        
        # æ¸…ç†ç³»ç»Ÿç¼“å­˜
        sudo apt-get clean
        sudo rm -rf /var/cache/apt/archives/*
        sudo rm -rf /tmp/*
        
        # ç§»é™¤.gitç›®å½•
        if [ -d "$BUILD_DIR/.git" ]; then
          echo "ç§»é™¤.gitç›®å½•èŠ‚çœç©ºé—´..."
          rm -rf "$BUILD_DIR/.git"
        fi
        
        # ç§»é™¤feedsç›®å½•ä¸­çš„.git
        find "$BUILD_DIR/feeds" -name ".git" -type d -exec rm -rf {} + 2>/dev/null || true
        
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      timeout-minutes: 20
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd $BUILD_DIR
        THREADS=${{ github.event.inputs.compile_threads }}
        
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆä½¿ç”¨ $THREADS çº¿ç¨‹ï¼‰..."
        for i in {1..3}; do
          echo "ç¬¬ $i æ¬¡å°è¯•ä¸‹è½½..."
          if make download -j$THREADS; then
            echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
            break
          else
            echo "âš ï¸ ç¬¬ $i æ¬¡ä¸‹è½½å¤±è´¥ï¼Œé‡è¯•..."
            sleep 5
          fi
        done
        
        if [ $? -ne 0 ]; then
          echo "âŒ è½¯ä»¶åŒ…ä¸‹è½½å¤±è´¥"
          exit 1
        fi

    - name: ç¼–è¯‘å›ºä»¶
      timeout-minutes: 300
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        cd $BUILD_DIR
        THREADS=${{ github.event.inputs.compile_threads }}
        
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "=== å½“å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        echo "=== å†…å­˜ä½¿ç”¨æƒ…å†µ ==="
        free -h
        
        echo "ğŸ”§ ä½¿ç”¨ $THREADS çº¿ç¨‹ç¼–è¯‘..."
        
        # åˆ†æ­¥ç¼–è¯‘ï¼Œæé«˜ç¨³å®šæ€§
        echo "æ­¥éª¤1: ç¼–è¯‘å·¥å…·é“¾..."
        if make tools/install -j$THREADS; then
          echo "âœ… å·¥å…·é“¾ç¼–è¯‘å®Œæˆ"
        else
          echo "âŒ å·¥å…·é“¾ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        echo "æ­¥éª¤2: ç¼–è¯‘å·¥å…·..."
        if make toolchain/install -j$THREADS; then
          echo "âœ… å·¥å…·ç¼–è¯‘å®Œæˆ"
        else
          echo "âŒ å·¥å…·ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        echo "æ­¥éª¤3: ç¼–è¯‘ç›®æ ‡..."
        if make target/install -j$THREADS; then
          echo "âœ… ç›®æ ‡ç¼–è¯‘å®Œæˆ"
        else
          echo "âŒ ç›®æ ‡ç¼–è¯‘å¤±è´¥"
          exit 1
        fi
        
        echo "æ­¥éª¤4: æœ€ç»ˆç¼–è¯‘..."
        if make -j$THREADS V=s; then
          echo "ğŸ‰ ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âŒ æœ€ç»ˆç¼–è¯‘å¤±è´¥"
          # è¾“å‡ºé”™è¯¯æ—¥å¿—
          find . -name "*.log" -exec tail -50 {} \; 2>/dev/null || true
          exit 1
        fi

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "ğŸ” æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶:"
        find "$BUILD_DIR/bin/targets/" -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null | head -10
        
        echo "=== æ–‡ä»¶å¤§å°ç»Ÿè®¡ ==="
        du -sh "$BUILD_DIR/bin/targets/" || true
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ä¸Šä¼ å›ºä»¶æ–‡ä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: |
          ${{ env.BUILD_DIR }}/bin/targets/**/*.bin
          ${{ env.BUILD_DIR }}/bin/targets/**/*.img
          ${{ env.BUILD_DIR }}/bin/targets/**/*.gz
        retention-days: 30

    - name: å®Œæˆæç¤º
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸŠ ç¼–è¯‘æˆåŠŸå®Œæˆï¼"
          echo "ğŸ“¥ å›ºä»¶æ–‡ä»¶å¯åœ¨ArtifactsåŒºåŸŸä¸‹è½½"
        else
          echo "âŒ ç¼–è¯‘è¿‡ç¨‹å‡ºç°é”™è¯¯"
          echo "ğŸ’¡ è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯"
        fi
