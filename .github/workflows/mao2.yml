name: æ ‹ä»”ä¸»é¢˜ç¼–è¯‘ä¼˜åŒ–ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      compile_threads:
        description: 'ç¼–è¯‘çº¿ç¨‹æ•°'
        required: false
        default: '1'
        type: choice
        options:
          - '1'
          - '2'

env:
  REPO_URL: https://github.com/coolsnowwolf/lede
  BUILD_DIR: lede

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    steps:
    - name: æ£€æŸ¥ä»£ç å’Œé…ç½®
      uses: actions/checkout@v4

    - name: åˆå§‹ç£ç›˜ç©ºé—´æ£€æŸ¥
      timeout-minutes: 15
      run: |
        echo "=== åˆå§‹ç£ç›˜ç©ºé—´çŠ¶æ€ ==="
        df -h
        echo "å¼€å§‹æ¸…ç†ç³»ç»Ÿç¼“å­˜..."
        sudo apt-get clean
        sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc 2>/dev/null || true
        sudo rm -rf /usr/local/lib/node_modules 2>/dev/null || true
        echo "=== æ¸…ç†åŽç£ç›˜ç©ºé—´ ==="
        df -h

    - name: éªŒè¯é…ç½®æ–‡ä»¶
      run: |
        if [ ! -f ".config" ]; then
          echo "âŒ é”™è¯¯ï¼šç¼ºå°‘é…ç½®æ–‡ä»¶ .config"
          echo "è¯·åœ¨å·¥ä½œæµè¿è¡Œå‰ä¸Šä¼  .config æ–‡ä»¶åˆ°ä»“åº“æ ¹ç›®å½•"
          exit 1
        else
          echo "âœ… æ‰¾åˆ°é…ç½®æ–‡ä»¶"
          echo "=== é…ç½®æ–‡ä»¶ä¿¡æ¯ ==="
          echo "æ–‡ä»¶å¤§å°: $(du -h .config | cut -f1)"
          echo "=== é…ç½®æ–‡ä»¶å‰30è¡Œé¢„è§ˆ ==="
          head -30 .config
          echo "=== é…ç½®æ–‡ä»¶åŽ10è¡Œé¢„è§ˆ ==="
          tail -10 .config
        fi

    - name: å®‰è£…ç¼–è¯‘çŽ¯å¢ƒ
      timeout-minutes: 15
      run: |
        echo "å®‰è£…ç¼–è¯‘çŽ¯å¢ƒ..."
        
        # æ›´æ–°è½¯ä»¶æº
        sudo apt update
        
        # å®‰è£…åŸºç¡€ç¼–è¯‘å·¥å…·
        sudo apt install -y build-essential git libncurses5-dev libssl-dev python3 unzip wget curl rsync file
        
        # å®‰è£…Python 2.7ï¼ˆOpenWrtç¼–è¯‘éœ€è¦ï¼‰
        echo "å®‰è£…Python 2.7..."
        sudo apt install -y python2.7
        # åˆ›å»ºpython2ç¬¦å·é“¾æŽ¥
        sudo ln -sf /usr/bin/python2.7 /usr/bin/python2
        # è®¾ç½®pythoné»˜è®¤ä¸ºpython3ï¼Œä½†ç¡®ä¿python2å¯ç”¨
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python3 1
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 2
        
        echo "âœ… çŽ¯å¢ƒå®‰è£…å®Œæˆ"
        
        # éªŒè¯Pythonç‰ˆæœ¬
        echo "=== Pythonç‰ˆæœ¬ä¿¡æ¯ ==="
        python --version
        python2 --version
        python3 --version
        
        sudo apt-get clean
        sudo rm -rf /var/lib/apt/lists/*

    - name: å…‹éš†æºç 
      timeout-minutes: 5
      run: |
        if [ -d "$BUILD_DIR" ]; then
          echo "åˆ é™¤å·²å­˜åœ¨çš„ $BUILD_DIR ç›®å½•"
          rm -rf $BUILD_DIR
        fi
        echo "å¼€å§‹å…‹éš†æºç ..."
        git clone --depth=1 $REPO_URL $BUILD_DIR
        echo "âœ… æºç å…‹éš†å®Œæˆ"
        df -h

    - name: æ›´æ–°è½¯ä»¶æº
      timeout-minutes: 5
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        echo "å¼€å§‹æ›´æ–°è½¯ä»¶æº..."
        cd $BUILD_DIR
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        echo "âœ… è½¯ä»¶æºæ›´æ–°å®Œæˆ"

    - name: åˆ›å»ºä¸»é¢˜ç›®å½•
      run: |
        mkdir -p "$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai/files/www/luci-static/dongzhai/css"
        echo "âœ… ä¸»é¢˜ç›®å½•åˆ›å»ºå®Œæˆ"

    - name: åˆ›å»ºä¸»é¢˜Makefile
      run: |
        THEME_DIR="$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai"
        if [ ! -d "$THEME_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼šä¸»é¢˜ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ä½¿ç”¨echoåˆ›å»ºMakefileï¼Œé¿å…heredocé—®é¢˜
        echo "include \$(TOPDIR)/rules.mk" > "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "LUCI_TITLE:=æ ‹ä»”ä¸»é¢˜" >> "$THEME_DIR/Makefile"
        echo "LUCI_DEPENDS:=" >> "$THEME_DIR/Makefile"
        echo "PKG_VERSION:=1.0" >> "$THEME_DIR/Makefile"
        echo "PKG_RELEASE:=1" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "include \$(INCLUDE_DIR)/package.mk" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "define Package/luci-theme-dongzhai" >> "$THEME_DIR/Makefile"
        echo "  \$(call Package/luci/webtemplate)" >> "$THEME_DIR/Makefile"
        echo "  TITLE:=æ ‹ä»”ä¸»é¢˜" >> "$THEME_DIR/Makefile"
        echo "  DEPENDS:=+luci-compat" >> "$THEME_DIR/Makefile"
        echo "endef" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "define Package/luci-theme-dongzhai/description" >> "$THEME_DIR/Makefile"
        echo "  æ ‹ä»”ä¸ªæ€§åŒ–ä¸»é¢˜" >> "$THEME_DIR/Makefile"
        echo "endef" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "define Build/Configure" >> "$THEME_DIR/Makefile"
        echo "endef" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "define Build/Compile" >> "$THEME_DIR/Makefile"
        echo "endef" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "define Package/luci-theme-dongzhai/install" >> "$THEME_DIR/Makefile"
        echo "	\$(INSTALL_DIR) \$(1)/www/luci-static/dongzhai" >> "$THEME_DIR/Makefile"
        echo "	[ -d ./files ] && \$(CP) ./files/* \$(1)/www/luci-static/dongzhai/" >> "$THEME_DIR/Makefile"
        echo "endef" >> "$THEME_DIR/Makefile"
        echo "" >> "$THEME_DIR/Makefile"
        echo "\$(eval \$(call BuildPackage,luci-theme-dongzhai))" >> "$THEME_DIR/Makefile"
        
        echo "âœ… ä¸»é¢˜Makefileåˆ›å»ºå®Œæˆ"

    - name: åˆ›å»ºä¸»é¢˜CSS
      run: |
        CSS_DIR="$BUILD_DIR/package/lean/dongzhai-theme/luci-theme-dongzhai/files/www/luci-static/dongzhai/css"
        if [ ! -d "$CSS_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼šCSSç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # ä½¿ç”¨echoåˆ›å»ºCSSï¼Œé¿å…heredocé—®é¢˜
        echo "/* æ ‹ä»”ä¸»é¢˜æ ·å¼ */" > "$CSS_DIR/style.css"
        echo ".header .fill .brand {" >> "$CSS_DIR/style.css"
        echo "    color: #ff6600;" >> "$CSS_DIR/style.css"
        echo "    font-weight: bold;" >> "$CSS_DIR/style.css"
        echo "    font-size: 18px;" >> "$CSS_DIR/style.css"
        echo "}" >> "$CSS_DIR/style.css"
        echo ".sidebar {" >> "$CSS_DIR/style.css"
        echo "    background: #2c3e50;" >> "$CSS_DIR/style.css"
        echo "}" >> "$CSS_DIR/style.css"
        echo ".sidebar .nav > li > a {" >> "$CSS_DIR/style.css"
        echo "    color: #ecf0f1;" >> "$CSS_DIR/style.css"
        echo "}" >> "$CSS_DIR/style.css"
        echo ".btn-primary {" >> "$CSS_DIR/style.css"
        echo "    background-color: #ff6600;" >> "$CSS_DIR/style.css"
        echo "    border-color: #ff6600;" >> "$CSS_DIR/style.css"
        echo "}" >> "$CSS_DIR/style.css"
        
        echo "âœ… ä¸»é¢˜CSSåˆ›å»ºå®Œæˆ"

    - name: åº”ç”¨é…ç½®æ–‡ä»¶
      timeout-minutes: 5
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "=== å½“å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        echo "å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°ç¼–è¯‘ç›®å½•..."
        if [ -f ".config" ]; then
          cp .config "$BUILD_DIR/.config"
          echo "âœ… é…ç½®æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          
          # æ˜¾ç¤ºé…ç½®æ–‡ä»¶ä¿¡æ¯
          echo "=== é…ç½®æ–‡ä»¶ç›®æ ‡ä¿¡æ¯ ==="
          echo "ç›®æ ‡è·¯å¾„: $BUILD_DIR/.config"
          echo "æ–‡ä»¶å¤§å°: $(du -h $BUILD_DIR/.config | cut -f1)"
        else
          echo "âŒ é”™è¯¯ï¼šæ ¹ç›®å½•ä¸‹æ²¡æœ‰æ‰¾åˆ° .config æ–‡ä»¶"
          exit 1
        fi
        
        cd "$BUILD_DIR"
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶å†…å®¹
        echo "=== é…ç½®æ–‡ä»¶å…³é”®é…ç½®æ£€æŸ¥ ==="
        grep -E "(CONFIG_TARGET_|CONFIG_PACKAGE_luci)" .config | head -20 || echo "æœªæ‰¾åˆ°ç›¸å…³é…ç½®"
        
        # ç¡®ä¿æ·»åŠ ä¸»é¢˜é…ç½®ï¼ˆå¦‚æžœé…ç½®æ–‡ä»¶ä¸­æ²¡æœ‰ï¼‰
        if ! grep -q "CONFIG_PACKAGE_luci-theme-dongzhai" .config; then
          echo "æ·»åŠ ä¸»é¢˜é…ç½®åˆ°é…ç½®æ–‡ä»¶..."
          echo "CONFIG_PACKAGE_luci-theme-dongzhai=y" >> .config
        fi
        
        echo "åº”ç”¨é…ç½®..."
        if make defconfig; then
          echo "âœ… é…ç½®åº”ç”¨å®Œæˆ"
          echo "=== æœ€ç»ˆé…ç½®é¢„è§ˆï¼ˆå…³é”®éƒ¨åˆ†ï¼‰==="
          grep -E "(CONFIG_TARGET_|CONFIG_PACKAGE_luci)" .config | head -30
        else
          echo "âŒ é…ç½®åº”ç”¨å¤±è´¥ï¼Œæ˜¾ç¤ºè¯¦ç»†é”™è¯¯..."
          make defconfig V=s
          exit 1
        fi

    - name: ç¼–è¯‘å‰æ·±åº¦æ¸…ç†
      timeout-minutes: 5
      run: |
        echo "=== ç¼–è¯‘å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        echo "æ‰§è¡Œæ·±åº¦æ¸…ç†..."
        
        # æ›´å½»åº•çš„æ¸…ç†
        sudo apt-get autoremove -y
        sudo apt-get clean
        sudo rm -rf /var/cache/apt/archives/*
        sudo rm -rf /var/lib/apt/lists/*
        sudo rm -rf /tmp/*
        sudo rm -rf /var/tmp/*
        
        # æ¸…ç†æ—¥å¿—æ–‡ä»¶
        sudo find /var/log -type f -name "*.log" -exec truncate -s 0 {} \;
        
        # ç§»é™¤.gitç›®å½•é‡Šæ”¾æ›´å¤šç©ºé—´
        if [ -d "$BUILD_DIR/.git" ]; then
          echo "ç§»é™¤.gitç›®å½•èŠ‚çœç©ºé—´..."
          rm -rf "$BUILD_DIR/.git"
        fi
        
        # æ¸…ç†æž„å»ºç¼“å­˜
        if [ -d "$BUILD_DIR/tmp" ]; then
          rm -rf "$BUILD_DIR/tmp"
        fi
        
        echo "=== æ¸…ç†åŽç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ä¸‹è½½è½¯ä»¶åŒ…
      timeout-minutes: 20
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        THREADS=${{ github.event.inputs.compile_threads }}
        echo "å¼€å§‹ä¸‹è½½è½¯ä»¶åŒ…ï¼ˆä½¿ç”¨ $THREADS çº¿ç¨‹ï¼‰..."
        echo "=== ä¸‹è½½å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        cd "$BUILD_DIR"
        if make download -j$THREADS; then
          echo "âœ… è½¯ä»¶åŒ…ä¸‹è½½å®Œæˆ"
        else
          echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹é‡è¯•..."
          make download -j1 V=s
        fi
        
        echo "=== ä¸‹è½½åŽç£ç›˜ç©ºé—´ ==="
        df -h

    - name: ç¼–è¯‘å›ºä»¶
      timeout-minutes: 300
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        THREADS=${{ github.event.inputs.compile_threads }}
        echo "å¼€å§‹ç¼–è¯‘å›ºä»¶..."
        echo "=== å½“å‰ç£ç›˜ç©ºé—´ ==="
        df -h
        
        cd "$BUILD_DIR"
        
        # æ£€æŸ¥ç£ç›˜ç©ºé—´ï¼Œå¦‚æžœä¸è¶³åˆ™æ¸…ç†
        AVAILABLE_SPACE=$(df /dev/root --output=avail | tail -1)
        if [ "$AVAILABLE_SPACE" -lt 1048576 ]; then  # å°äºŽ1GB
          echo "âš ï¸ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œæ‰§è¡Œç´§æ€¥æ¸…ç†..."
          make dirclean
          sudo rm -rf /tmp/*
          df -h
        fi
        
        echo "ðŸ”§ ä½¿ç”¨ $THREADS çº¿ç¨‹ç¼–è¯‘..."
        if make -j$THREADS; then
          echo "ðŸŽ‰ ç¼–è¯‘æˆåŠŸï¼"
        else
          echo "âš ï¸ ç¼–è¯‘å¤±è´¥ï¼Œä½¿ç”¨è¯¦ç»†æ¨¡å¼é‡è¯•..."
          make -j1 V=s
        fi

    - name: æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
      run: |
        if [ ! -d "$BUILD_DIR" ]; then
          echo "âŒ é”™è¯¯ï¼š$BUILD_DIR ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "ðŸ” æŸ¥æ‰¾ç”Ÿæˆçš„å›ºä»¶æ–‡ä»¶..."
        
        # è¯¦ç»†æŸ¥æ‰¾æ‰€æœ‰å¯èƒ½çš„å›ºä»¶æ–‡ä»¶
        echo "=== æ‰€æœ‰ targets ç›®å½•ç»“æž„ ==="
        find "$BUILD_DIR/bin/targets" -type d 2>/dev/null | head -20
        
        echo "=== æ‰€æœ‰ bin æ–‡ä»¶ ==="
        find "$BUILD_DIR/bin/targets" -name "*.bin" -type f 2>/dev/null | head -10
        
        echo "=== æ‰€æœ‰ img æ–‡ä»¶ ==="
        find "$BUILD_DIR/bin/targets" -name "*.img" -type f 2>/dev/null | head -10
        
        echo "=== æ‰€æœ‰å›ºä»¶ç›¸å…³æ–‡ä»¶ ==="
        find "$BUILD_DIR/bin/targets" -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" -o -name "*.trx" -o -name "*.combined" \) 2>/dev/null | head -20
        
        echo "=== æœ€ç»ˆç£ç›˜ç©ºé—´ ==="
        df -h

    - name: å¿«é€Ÿä¸Šä¼ .binå›ºä»¶ï¼ˆå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
      if: always()  # æ— è®ºç¼–è¯‘æˆåŠŸä¸Žå¦éƒ½æ‰§è¡Œ
      run: |
        echo "ðŸš€ å¿«é€Ÿä¸Šä¼ .binå›ºä»¶..."
        
        # æŸ¥æ‰¾æ‰€æœ‰.binæ–‡ä»¶
        BIN_FILES=$(find "$BUILD_DIR/bin/targets" -name "*.bin" -type f 2>/dev/null | head -10)
        
        if [ -n "$BIN_FILES" ]; then
          echo "âœ… æ‰¾åˆ°ä»¥ä¸‹.binæ–‡ä»¶:"
          echo "$BIN_FILES"
          
          # åˆ›å»ºå¿«é€Ÿä¸Šä¼ ç›®å½•
          mkdir -p "/tmp/quick_firmware"
          
          # å¤åˆ¶å‰5ä¸ª.binæ–‡ä»¶åˆ°ä¸´æ—¶ç›®å½•
          COUNT=0
          for bin_file in $BIN_FILES; do
            if [ $COUNT -lt 5 ]; then
              filename=$(basename "$bin_file")
              echo "å¤åˆ¶: $filename"
              cp "$bin_file" "/tmp/quick_firmware/"
              COUNT=$((COUNT+1))
            fi
          done
          
          echo "âœ… å·²å‡†å¤‡ $COUNT ä¸ª.binæ–‡ä»¶ç”¨äºŽå¿«é€Ÿä¸Šä¼ "
        else
          echo "âš ï¸ æœªæ‰¾åˆ°.binæ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–å›ºä»¶æ ¼å¼..."
          # æŸ¥æ‰¾å…¶ä»–æ ¼å¼çš„å›ºä»¶
          OTHER_FILES=$(find "$BUILD_DIR/bin/targets" -type f \( -name "*.img" -o -name "*.trx" -o -name "*.combined" -o -name "*.gz" \) 2>/dev/null | head -5)
          if [ -n "$OTHER_FILES" ]; then
            echo "æ‰¾åˆ°å…¶ä»–æ ¼å¼å›ºä»¶:"
            echo "$OTHER_FILES"
            mkdir -p "/tmp/quick_firmware"
            COUNT=0
            for file in $OTHER_FILES; do
              if [ $COUNT -lt 5 ]; then
                filename=$(basename "$file")
                echo "å¤åˆ¶: $filename"
                cp "$file" "/tmp/quick_firmware/"
                COUNT=$((COUNT+1))
              fi
            done
          else
            echo "âŒ æœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶"
            # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
            mkdir -p "/tmp/quick_firmware"
            echo "æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥.configé…ç½®" > "/tmp/quick_firmware/README.txt"
          fi
        fi

    - name: ä¸Šä¼ å¿«é€Ÿå›ºä»¶
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: quick-firmware-bin
        path: /tmp/quick_firmware/
        retention-days: 30
        if-no-files-found: ignore

    - name: æ‰“åŒ…å›ºä»¶æ–‡ä»¶
      if: success()
      run: |
        echo "ðŸ“¦ æ‰“åŒ…å›ºä»¶æ–‡ä»¶..."
        
        # é¦–å…ˆæ£€æŸ¥æ˜¯å¦æœ‰å›ºä»¶æ–‡ä»¶ç”Ÿæˆ
        if [ ! -d "$BUILD_DIR/bin/targets" ]; then
          echo "âŒ é”™è¯¯ï¼štargetsç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        # æŸ¥æ‰¾æ‰€æœ‰å›ºä»¶æ–‡ä»¶
        FIRMWARE_FILES=$(find "$BUILD_DIR/bin/targets" -type f \( -name "*.bin" -o -name "*.img" -o -name "*.gz" \) 2>/dev/null)
        
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "âš ï¸ æœªæ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–æ–‡ä»¶ç±»åž‹..."
          find "$BUILD_DIR/bin/targets" -type f | head -20
          echo "âŒ æ— æ³•æ‰¾åˆ°å›ºä»¶æ–‡ä»¶ï¼Œæ‰“åŒ…å¤±è´¥"
          exit 1
        fi
        
        echo "æ‰¾åˆ°ä»¥ä¸‹å›ºä»¶æ–‡ä»¶:"
        echo "$FIRMWARE_FILES"
        
        # åˆ›å»ºå›ºä»¶åŒ…
        cd "$BUILD_DIR"
        if zip -r firmware.zip bin/targets/ -i "*.bin" "*.img" "*.gz" "*.trx" "*.combined" 2>/dev/null; then
          echo "âœ… å›ºä»¶æ‰“åŒ…å®Œæˆ"
          ls -lh firmware.zip
        else
          echo "âš ï¸ zipæ‰“åŒ…å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨tar..."
          if tar -czf firmware.tar.gz bin/targets/ --transform 's|bin/targets/||' 2>/dev/null; then
            echo "âœ… å›ºä»¶taræ‰“åŒ…å®Œæˆ"
            ls -lh firmware.tar.gz
            # é‡å‘½åä¸ºzipä»¥ä¿æŒåŽç»­æ­¥éª¤å…¼å®¹
            mv firmware.tar.gz firmware.zip
          else
            echo "âŒ æ‰€æœ‰æ‰“åŒ…æ–¹æ³•éƒ½å¤±è´¥"
            # åˆ›å»ºç©ºçš„firmware.zipä»¥é¿å…åŽç»­æ­¥éª¤å¤±è´¥
            touch firmware.zip
          fi
        fi

    - name: ä¸Šä¼ å›ºä»¶
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-firmware
        path: ${{ env.BUILD_DIR }}/firmware.zip
        retention-days: 30
        if-no-files-found: warn

    - name: ä¸Šä¼ åŽŸå§‹æ–‡ä»¶ï¼ˆå¤‡ç”¨ï¼‰
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: firmware-backup
        path: ${{ env.BUILD_DIR }}/bin/targets/
        retention-days: 7
        if-no-files-found: warn

    - name: å®Œæˆæç¤º
      if: always()
      run: |
        echo "=== ç¼–è¯‘ç»“æžœæ€»ç»“ ==="
        
        # æ£€æŸ¥å¿«é€Ÿå›ºä»¶æ˜¯å¦å­˜åœ¨
        if [ -d "/tmp/quick_firmware" ] && [ "$(ls -A /tmp/quick_firmware 2>/dev/null)" ]; then
          echo "ðŸŽ‰ å¿«é€Ÿå›ºä»¶å·²ä¸Šä¼ ï¼"
          echo "ðŸ“¦ æ–‡ä»¶ï¼šquick-firmware-bin"
          echo "ðŸ“„ åŒ…å«æ–‡ä»¶:"
          ls -la "/tmp/quick_firmware/" 2>/dev/null || echo "å¿«é€Ÿå›ºä»¶ç›®å½•ä¸ºç©º"
        fi
        
        # æ£€æŸ¥å®Œæ•´å›ºä»¶åŒ…æ˜¯å¦å­˜åœ¨
        if [ -f "$BUILD_DIR/firmware.zip" ] && [ -s "$BUILD_DIR/firmware.zip" ]; then
          echo "âœ… å®Œæ•´å›ºä»¶åŒ…å·²ä¸Šä¼ "
          echo "ðŸ“¦ æ–‡ä»¶ï¼šopenwrt-firmware.zip"
          echo "ðŸ“Š æ–‡ä»¶å¤§å°: $(du -h $BUILD_DIR/firmware.zip | cut -f1)"
        fi
        
        # æ£€æŸ¥åŽŸå§‹æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -d "$BUILD_DIR/bin/targets" ] && [ "$(ls -A $BUILD_DIR/bin/targets 2>/dev/null)" ]; then
          echo "ðŸ“ åŽŸå§‹æ–‡ä»¶å·²å¤‡ä»½"
          echo "ðŸ“¦ æ–‡ä»¶ï¼šfirmware-backup"
        fi
        
        echo ""
        echo "ðŸ“¥ ä¸‹è½½é“¾æŽ¥å°†åœ¨ArtifactsåŒºåŸŸæ˜¾ç¤º"
        echo "ðŸ’¡ æç¤ºï¼šå¦‚æžœç¼–è¯‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥quick-firmware-binä¸­æ˜¯å¦æœ‰éƒ¨åˆ†ç¼–è¯‘æˆæžœ"
        echo "ðŸ•’ ç¼–è¯‘æµç¨‹å®Œæˆæ—¶é—´: $(date)"
        echo "ðŸ”§ ä½¿ç”¨çš„é…ç½®æ–‡ä»¶: $(du -h .config 2>/dev/null | cut -f1 || echo 'æœªçŸ¥')"
